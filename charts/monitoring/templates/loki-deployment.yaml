# charts/monitoring/templates/loki-deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki
  namespace: {{ .Release.Namespace }} # –î–æ–ª–∂–µ–Ω –±—ã—Ç—å 'loki'
  labels:
    app: loki
spec:
  replicas: {{ .Values.loki.replicaCount | default 1 }}
  selector:
    matchLabels:
      app: loki
  template:
    metadata:
      labels:
        app: loki
    spec:
      # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Secret —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—Å–æ–∑–¥–∞–Ω –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ ESO)
      serviceAccountName: loki-sa # –ï—Å–ª–∏ –Ω—É–∂–µ–Ω ServiceAccount –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Secret
      containers:
        - name: loki
          image: "{{ .Values.loki.image }}" # –Ω–∞–ø—Ä–∏–º–µ—Ä, grafana/loki:2.8.2
          imagePullPolicy: IfNotPresent
          args:
            - "-config.file=/etc/loki/config.yaml"
          ports:
            - name: http-metrics
              containerPort: {{ .Values.loki.port }}
              protocol: TCP
          
          # üîë 1. –ü–†–û–ë–†–û–° –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø (–°–ï–ö–†–ï–¢–´ AZURE)
          env:
{{- range $key := .Values.loki.secretEnvKeys }} # –¶–∏–∫–ª –ø–æ —Å–ø–∏—Å–∫—É AZURE_STORAGE_ACCOUNT –∏ —Ç.–¥.
            - name: {{ $key }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.loki.secretName }} # –ò–º—è –æ–±—â–µ–≥–æ Secret: db-credentials
                  key: {{ $key }} # –ö–ª—é—á, –Ω–∞–ø—Ä–∏–º–µ—Ä: AZURE_STORAGE_KEY
{{- end }}

          # üîë 2. –ú–û–ù–¢–ò–†–û–í–ê–ù–ò–ï CONFIGMAP
          volumeMounts:
            - name: config
              mountPath: /etc/loki
              readOnly: true
          
          resources: # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã
            limits:
              cpu: 500m
              memory: 1Gi
            requests:
              cpu: 100m
              memory: 512Mi

      # üîë 3. –û–ë–™–Ø–í–õ–ï–ù–ò–ï –¢–û–ú–û–í (VOLUME)
      volumes:
        - name: config
          configMap:
            name: loki-config # –ò–º—è ConfigMap, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Å–æ–∑–¥–∞–¥–∏—Ç–µ