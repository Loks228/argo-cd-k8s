apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki
  labels:
    app: loki
spec:
  replicas: {{ .Values.loki.replicas | default 1 }}
  selector:
    matchLabels:
      app: loki
  template:
    metadata:
      labels:
        app: loki
    spec:
      serviceAccountName: loki-sa
      containers:
        - name: loki
          image: "{{ .Values.loki.image.repository }}:{{ .Values.loki.image.tag }}"
          # Use envsubst to replace ${VAR} placeholders in /etc/loki/config.yaml before starting loki binary
          command:
            - /bin/sh
            - -c
            - |
              set -e
              # substitute env vars into config and start loki
              envsubst < /etc/loki/config.yaml > /etc/loki/config.generated.yaml
              exec /usr/bin/loki -config.file=/etc/loki/config.generated.yaml
          ports:
            - containerPort: {{ .Values.service.targetPort | default 3100 }}
          env:
{{- if .Values.commonEnv.secretName }}
{{- range $i, $key := .Values.commonEnv.envKeys }}
            - name: {{ $key }}
              valueFrom:
                secretKeyRef:
                  name: {{ $.Values.commonEnv.secretName }}
                  key: {{ $key }}
{{- end }}
{{- end }}
          volumeMounts:
            - name: loki-config
              mountPath: /etc/loki
              readOnly: true
            - name: loki-wal
              mountPath: /var/loki/wal
            - name: loki-index
              mountPath: /var/loki/index
            - name: loki-cache
              mountPath: /var/loki/cache
      volumes:
        - name: loki-config
          configMap:
            name: {{ .Values.configMap.name | default "loki-config" }}
        - name: loki-wal
          emptyDir: {}
        - name: loki-index
          emptyDir: {}
        - name: loki-cache
          emptyDir: {}